{% extends 'base.html' %}

{% block title %}Update Availability - MatchFeeMate{% endblock %}

{% block content %}
<h1 class="h5 mb-3 text-success">Availability</h1>
<!-- Match header - consistent with match list -->
<div class="card card-mfm mb-3{% if match.status == 'cancelled' %} opacity-50{% elif match.status == 'completed' %} opacity-75{% endif %}">
    <div class="card-body p-2">
        <div class="lh-1">
            <strong>{{ match.date|date:"D d M" }} ({% if match.is_home %}H{% else %}A{% endif %}) v {{ match.opposition.name }}</strong>
        </div>
        <div class="small mt-1">
            {{ match.venue|default:"TBC" }} · {{ match.time|time:"g:ia"|default:"TBC" }} · 
            <span class="{% if match.status == 'cancelled' %}text-danger{% elif match.status == 'completed' %}text-success fst-italic{% endif %}">{{ match.get_status_display }}</span> · 
            Team: <span class="{% if selected_players|length >= 11 %}text-success{% else %}text-warning{% endif %}">{{ selected_players|length }}/11</span>{% if selected_players|length >= 11 %} <em class="text-success">Full</em>{% endif %}
        </div>
    </div>
</div>

<form method="post">
    {% csrf_token %}
    
    <div class="accordion" id="availabilityAccordion">
        <!-- Selected players -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button card-header-selected py-2" type="button" data-bs-toggle="collapse" data-bs-target="#selectedPlayers" aria-expanded="true">
                    <strong>Selected ({{ selected_players|length }})</strong>{% if selected_players|length >= 11 %}&nbsp;<em class="text-success">Full</em>{% endif %}
                </button>
            </h2>
            <div id="selectedPlayers" class="accordion-collapse collapse show" data-bs-parent="#availabilityAccordion">
                <div class="accordion-body py-2">
                    {% for player in selected_players %}
                    <div class="form-check py-1 {% if not forloop.last %}border-bottom{% endif %} d-flex justify-content-between align-items-center">
                        <div>
                            <input class="form-check-input" type="checkbox" name="players" value="{{ player.pk }}" id="selected_{{ player.pk }}">
                            <label class="form-check-label" for="selected_{{ player.pk }}">{{ player.name }}{% if player.role != 'player' %}<sup class="admin-badge">{{ player.get_role_display }}</sup>{% endif %}</label>
                        </div>
                        <a href="{% url 'player_availability' player_pk=player.pk %}" class="small text-decoration-underline {% if player.current_availability == 'Available' %}text-success{% elif player.current_availability == 'Maybe' %}text-warning{% else %}text-danger{% endif %}">{{ player.current_availability }}</a>
                    </div>
                    {% empty %}
                    <p class="text-muted mb-0 small">No players selected yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Available players -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed card-header-available py-2" type="button" data-bs-toggle="collapse" data-bs-target="#availablePlayers" aria-expanded="false">
                    <strong>Available ({{ available_players|length }})</strong>
                </button>
            </h2>
            <div id="availablePlayers" class="accordion-collapse collapse" data-bs-parent="#availabilityAccordion">
                <div class="accordion-body py-2">
                    {% for player in available_players %}
                    <div class="form-check py-1 {% if not forloop.last %}border-bottom{% endif %} d-flex justify-content-between align-items-center">
                        <div>
                            <input class="form-check-input" type="checkbox" name="players" value="{{ player.pk }}" id="avail_{{ player.pk }}">
                            <label class="form-check-label" for="avail_{{ player.pk }}">{{ player.name }}{% if player.role != 'player' %}<sup class="admin-badge">{{ player.get_role_display }}</sup>{% endif %}</label>
                        </div>
                        <a href="{% url 'player_availability' player_pk=player.pk %}" class="small text-decoration-underline text-success">Available</a>
                    </div>
                    {% empty %}
                    <p class="text-muted mb-0 small">No players available.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Maybe players -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed card-header-maybe py-2" type="button" data-bs-toggle="collapse" data-bs-target="#maybePlayers" aria-expanded="false">
                    <strong>Maybe ({{ maybe_players|length }})</strong>
                </button>
            </h2>
            <div id="maybePlayers" class="accordion-collapse collapse" data-bs-parent="#availabilityAccordion">
                <div class="accordion-body py-2">
                    {% for player in maybe_players %}
                    <div class="form-check py-1 {% if not forloop.last %}border-bottom{% endif %} d-flex justify-content-between align-items-center">
                        <div>
                            <input class="form-check-input" type="checkbox" name="players" value="{{ player.pk }}" id="maybe_{{ player.pk }}">
                            <label class="form-check-label" for="maybe_{{ player.pk }}">{{ player.name }}{% if player.role != 'player' %}<sup class="admin-badge">{{ player.get_role_display }}</sup>{% endif %}</label>
                        </div>
                        <a href="{% url 'player_availability' player_pk=player.pk %}" class="small text-decoration-underline text-warning">Maybe</a>
                    </div>
                    {% empty %}
                    <p class="text-muted mb-0 small">No players with maybe status.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Awaiting response -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed bg-secondary-subtle text-dark py-2" type="button" data-bs-toggle="collapse" data-bs-target="#awaitingPlayers" aria-expanded="false">
                    <strong>Awaiting Response ({{ awaiting_players|length }})</strong>
                </button>
            </h2>
            <div id="awaitingPlayers" class="accordion-collapse collapse" data-bs-parent="#availabilityAccordion">
                <div class="accordion-body py-2">
                    {% for player in awaiting_players %}
                    <div class="form-check py-1 {% if not forloop.last %}border-bottom{% endif %} d-flex justify-content-between align-items-center">
                        <div>
                            <input class="form-check-input" type="checkbox" name="players" value="{{ player.pk }}" id="awaiting_{{ player.pk }}">
                            <label class="form-check-label" for="awaiting_{{ player.pk }}">{{ player.name }}{% if player.role != 'player' %}<sup class="admin-badge">{{ player.get_role_display }}</sup>{% endif %}</label>
                        </div>
                        <a href="{% url 'player_availability' player_pk=player.pk %}" class="small text-decoration-underline text-muted">Awaiting</a>
                    </div>
                    {% empty %}
                    <p class="text-muted mb-0 small">No players awaiting response.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Unavailable players -->
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed bg-danger-subtle text-dark py-2" type="button" data-bs-toggle="collapse" data-bs-target="#unavailablePlayers" aria-expanded="false">
                    <strong>Unavailable ({{ unavailable_players|length }})</strong>
                </button>
            </h2>
            <div id="unavailablePlayers" class="accordion-collapse collapse" data-bs-parent="#availabilityAccordion">
                <div class="accordion-body py-2">
                    {% for player in unavailable_players %}
                    <div class="form-check py-1 {% if not forloop.last %}border-bottom{% endif %} d-flex justify-content-between align-items-center">
                        <div>
                            <input class="form-check-input" type="checkbox" name="players" value="{{ player.pk }}" id="unavail_{{ player.pk }}">
                            <label class="form-check-label" for="unavail_{{ player.pk }}">{{ player.name }}{% if player.role != 'player' %}<sup class="admin-badge">{{ player.get_role_display }}</sup>{% endif %}</label>
                        </div>
                        <a href="{% url 'player_availability' player_pk=player.pk %}" class="small text-decoration-underline text-danger">Unavailable</a>
                    </div>
                    {% empty %}
                    <p class="text-muted mb-0 small">No players unavailable.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sticky bottom: buttons -->
    <div class="position-sticky bottom-0 pt-2 pb-3" style="background-color: var(--mfm-cream); margin-left: -1rem; margin-right: -1rem; padding-left: 1rem; padding-right: 1rem;">
        <div class="d-flex justify-content-center align-items-center gap-2 mb-2">
            <span><strong>Set to:</strong></span>
            <button type="submit" name="availability" value="yes" class="btn btn-success btn-sm">Available</button>
            <button type="submit" name="availability" value="maybe" class="btn btn-mfm-warning btn-sm">Maybe</button>
            <button type="submit" name="availability" value="no" class="btn btn-danger btn-sm">Unavailable</button>
        </div>
        <div class="d-flex justify-content-center">
            <a href="{% url 'match_list' %}" class="btn btn-outline-secondary btn-sm">Back</a>
        </div>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const openSection = urlParams.get('open');
        
        if (openSection) {
            const selectedAccordion = document.getElementById('selectedPlayers');
            if (selectedAccordion) {
                selectedAccordion.classList.remove('show');
                selectedAccordion.previousElementSibling.querySelector('button').classList.add('collapsed');
            }
            
            let targetId = null;
            if (openSection === 'available') {
                targetId = 'availablePlayers';
            } else if (openSection === 'maybe') {
                targetId = 'maybePlayers';
            }
            
            if (targetId) {
                const targetAccordion = document.getElementById(targetId);
                if (targetAccordion) {
                    targetAccordion.classList.add('show');
                    targetAccordion.previousElementSibling.querySelector('button').classList.remove('collapsed');
                }
            }
        }
    });
</script>
{% endblock %}