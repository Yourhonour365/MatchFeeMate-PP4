{% extends 'base.html' %}

{% block title %}{{ match.club.name }} vs {{ match.opposition.name }} - MatchFeeMate{% endblock %}

{% block content %}
<!-- Match details card - compact -->
<div class="card card-mfm mb-3">
    <div class="card-body py-2">
        <h5 class="card-title mb-0">vs {{ match.opposition.name }} ({% if match.is_home %}H{% else %}A{% endif %})</h5>
        <small class="text-muted fst-italic">{{ match.get_status_display }}</small>
        <p class="small mb-1 mt-1"><strong>{{ match.date|date:"D d M Y" }}</strong> {{ match.time|default:"" }} · {{ match.venue|default:"TBC" }} · £{{ match.match_fee|default:"TBC" }}</p>
        
        <!-- Actions - admin/captain only -->
        {% if is_admin_or_captain %}
        <div class="d-flex gap-2 mt-2">
            <a href="#availability" class="btn btn-mfm-dark-blue btn-sm d-md-none">View Availability</a>
            <a href="{% url 'match_update' pk=match.pk %}" class="btn btn-mfm-brown btn-sm">Edit Match</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Warning for unavailable selected players - admin/captain only -->
{% if is_admin_or_captain and unavailable_selected %}
<div class="alert alert-mfm-error mb-3 py-2 alert-dismissible fade show">
    <strong>Warning:</strong> The following selected players have not confirmed availability:
    {% for mp in unavailable_selected %}{{ mp.player.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
    <button type="button" class="btn btn-sm btn-outline-dark ms-2" data-bs-dismiss="alert">Dismiss</button>
</div>
{% endif %}

<!-- Selected Team card -->
<div class="card card-mfm mb-3">
    <div class="card-header py-1 card-header-selected d-flex justify-content-between align-items-center">
        <strong>Selected ({{ selected_count }}/11)</strong>
        {% if is_admin_or_captain %}
        <a href="{% url 'team_selection' match_pk=match.pk %}" class="btn btn-mfm-primary btn-sm py-0">Edit Selection</a>
        {% endif %}
    </div>
    <div class="card-body py-2">
        {% with selected=match.match_players.all|dictsort:"player.name" %}
            {% for mp in selected %}
                {% if mp.selected %}
                <div class="d-flex justify-content-between align-items-center py-1 {% if not forloop.last %}border-bottom{% endif %}">
                    <span class="{% if mp.player == current_player %}fw-bold fst-italic{% endif %}">{{ mp.player.name }}</span>
                    {% if is_admin_or_captain %}
                    <a href="{% url 'player_availability' player_pk=mp.player.pk %}" class="small text-decoration-underline {% if mp.availability == 'yes' %}text-success{% elif mp.availability == 'no' %}text-danger{% else %}text-warning{% endif %}">
                        {% if mp.availability == 'yes' %}Available{% elif mp.availability == 'no' %}Unavailable{% else %}Maybe{% endif %}
                    </a>
                    {% else %}
                    <small class="{% if mp.availability == 'yes' %}text-success{% elif mp.availability == 'no' %}text-danger{% else %}text-warning{% endif %}">
                        {% if mp.availability == 'yes' %}Available{% elif mp.availability == 'no' %}Unavailable{% else %}Maybe{% endif %}
                    </small>
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        {% endwith %}
        {% if selected_count == 0 %}
            <p class="text-muted mb-0 small">No players selected yet.</p>
        {% endif %}
    </div>
</div>

{% if is_admin_or_captain %}
<!-- Available Players card - admin only -->
<div class="card card-mfm mb-3" id="availability">
    <div class="card-header py-1 card-header-available d-flex justify-content-between align-items-center">
        <strong>Available ({{ available_count }})</strong>
        <a href="{% url 'bulk_availability' match_pk=match.pk %}" class="btn btn-mfm-dark-blue btn-sm py-0">Edit Availability</a>
    </div>
    <div class="card-body py-2">
        {% for mp in match.match_players.all|dictsort:"player.name" %}
            {% if not mp.selected and mp.availability == 'yes' %}
            <div class="d-flex justify-content-between align-items-center py-1 {% if not forloop.last %}border-bottom{% endif %}">
                <span>{{ mp.player.name }}</span>
                <a href="{% url 'player_availability' player_pk=mp.player.pk %}" class="small text-decoration-underline text-success">Available</a>
            </div>
            {% endif %}
        {% empty %}
            <p class="text-muted mb-0 small">No players available.</p>
        {% endfor %}
    </div>
</div>

<!-- Maybe/Unavailable - admin only -->
<div class="card card-mfm mb-3">
    <div class="card-header py-1 card-header-maybe">
        <strong>Maybe / Unavailable</strong>
    </div>
    <div class="card-body py-2">
        {% for mp in match.match_players.all|dictsort:"player.name" %}
            {% if not mp.selected and mp.availability != 'yes' %}
            <div class="d-flex justify-content-between align-items-center py-1 {% if not forloop.last %}border-bottom{% endif %}">
                <span>{{ mp.player.name }}</span>
                <a href="{% url 'player_availability' player_pk=mp.player.pk %}" class="small text-decoration-underline {% if mp.availability == 'no' %}text-danger{% else %}text-warning{% endif %}">
                    {% if mp.availability == 'no' %}Unavailable{% else %}Maybe{% endif %}
                </a>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Not Responded - admin only -->
{% if not_responded %}
<div class="card card-mfm mb-3">
    <div class="card-header py-1 bg-light">
        <strong>Awaiting Response ({{ not_responded|length }})</strong>
    </div>
    <div class="card-body py-2">
        {% for player in not_responded %}
        <div class="d-flex justify-content-between align-items-center py-1 {% if not forloop.last %}border-bottom{% endif %}">
            <span>{{ player.name }}</span>
            <a href="{% url 'player_availability' player_pk=player.pk %}" class="small text-decoration-underline text-muted">Not Set</a>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endif %}

<!-- Your Availability at bottom - all players can see -->
<div class="card card-mfm mb-3">
    <div class="card-body py-2">
        <strong class="small">Your Availability:</strong>
        <div class="d-flex gap-2 mt-1">
            <a href="{% url 'set_availability' match_pk=match.pk availability='yes' %}" class="btn btn-success btn-sm flex-fill d-flex align-items-center justify-content-center">Available</a>
            <a href="{% url 'set_availability' match_pk=match.pk availability='maybe' %}" class="btn btn-mfm-warning btn-sm flex-fill d-flex align-items-center justify-content-center">Maybe</a>
            <a href="{% url 'set_availability' match_pk=match.pk availability='no' %}" class="btn btn-danger btn-sm flex-fill d-flex align-items-center justify-content-center">Unavailable</a>
        </div>
    </div>
</div>

<!-- Delete link - admin/captain only -->
{% if is_admin_or_captain %}
<div class="text-center">
    <small><a href="{% url 'match_delete' pk=match.pk %}" class="text-danger">Delete match</a></small>
</div>
{% endif %}
{% endblock %}