{% extends 'base.html' %}

{% block title %}{% if is_admin_view %}{{ player.name }}'s Availability{% else %}My Availability{% endif %} - MatchFeeMate{% endblock %}

{% block content %}
<h1 class="h5 mb-3 text-success">{% if is_admin_view %}{{ player.name }}'s Participation{% else %}My Participation{% endif %}</h1>

<div class="d-flex gap-2 mb-3">
    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectAll()">Select All</button>
    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectNone()">Clear</button>
</div>

<form method="post">
    {% csrf_token %}
    
    <!-- Match list -->
    {% if matches %}
        {% for match in matches %}
        <div class="card card-mfm mb-2{% if match.status == 'cancelled' %} opacity-50{% elif match.status == 'completed' %} opacity-75{% endif %}">
            <div class="card-body p-2">
                <!-- Row 1: Checkbox + Date, H/A, Opposition, Time -->
                <div class="d-flex align-items-center lh-1">
                    <input class="form-check-input match-checkbox me-2" type="checkbox" name="matches" value="{{ match.pk }}" id="match{{ match.pk }}">
                    <label class="form-check-label" for="match{{ match.pk }}">
                        <strong>{{ match.date|date:"D d M" }} {{ match.time|time:"H:i"|default:"TBC" }} ({% if match.is_home %}H{% else %}A{% endif %}) v {{ match.opposition.name }}</strong>
                    </label>
                </div>
                
                <!-- Row 2: Availability, Selection · Team count -->
                <div class="small mt-1" style="margin-left: 1.5rem;">
                    <span class="{% if match.my_availability == 'yes' %}text-success{% elif match.my_availability == 'maybe' %}text-warning{% elif match.my_availability == 'no' %}text-danger{% else %}text-muted{% endif %}">
                        {% if match.my_availability == 'yes' %}Available{% elif match.my_availability == 'maybe' %}Maybe{% elif match.my_availability == 'no' %}Unavailable{% else %}Not Set{% endif %}{% if match.is_selected %}, Selected{% endif %}
                    </span>
                    <span class="text-muted">·</span>
                    Team: <a href="{% url 'team_selection' match_pk=match.pk %}" class="{% if match.selected_count >= 11 %}text-success{% else %}text-warning{% endif %}">{{ match.selected_count }}/11{% if match.selected_count >= 11 %} Full{% endif %}</a>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p class="text-muted">No matches scheduled.</p>
    {% endif %}
    
    <!-- Sticky bottom: buttons -->
    <div class="position-sticky bottom-0 py-2" style="background-color: var(--mfm-cream); margin-left: -1rem; margin-right: -1rem; padding-left: 1rem; padding-right: 1rem;">
        <div class="d-flex justify-content-center flex-wrap gap-2 mb-2">
            <button type="submit" name="availability" value="yes" class="btn btn-success btn-sm">Available</button>
            <button type="submit" name="availability" value="maybe" class="btn btn-mfm-warning btn-sm">Maybe</button>
            <button type="submit" name="availability" value="no" class="btn btn-danger btn-sm">Unavailable</button>
        </div>
        {% if is_admin_view or is_admin_or_captain %}
        <div class="d-flex justify-content-center flex-wrap gap-2 mb-2">
            <button type="submit" name="team_action" value="add" class="btn btn-mfm-primary btn-sm">Add to Team</button>
            <button type="submit" name="team_action" value="remove" class="btn btn-outline-danger btn-sm">Remove from Team</button>
        </div>
        {% endif %}
        <div class="d-flex justify-content-center">
            <a href="{% url 'match_list' %}" class="btn btn-outline-secondary btn-sm">Exit</a>
        </div>
    </div>
</form>

<script>
function selectAll() {
    document.querySelectorAll('.match-checkbox').forEach(cb => cb.checked = true);
}
function selectNone() {
    document.querySelectorAll('.match-checkbox').forEach(cb => cb.checked = false);
}
</script>
{% endblock %}